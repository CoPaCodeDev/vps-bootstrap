# Production Docker Compose
# Deployment auf dem Proxy-Server (10.10.0.1)
#
# Starten mit: docker compose -f docker-compose.prod.yml up -d
# Danach Route löschen falls vorhanden: rm /opt/traefik/conf.d/dash*.yml
# Traefik-Labels übernehmen das Routing automatisch.

services:
  backend:
    build: ./backend
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 2
    networks:
      - traefik
    user: "1000:1000"
    volumes:
      - /home/master/.ssh:/home/master/.ssh:ro
      - /etc/vps-hosts:/etc/vps-hosts:ro
      - /opt/vps:/opt/vps:ro
      - /opt/traefik:/opt/traefik
      - /opt/authelia:/opt/authelia
      - /home/master/.config/vps-cli:/home/master/.config/vps-cli
    environment:
      - VPS_DASHBOARD_DEBUG=false
      - HOME=/home/master
    restart: unless-stopped

  frontend:
    build: ./frontend
    networks:
      - traefik
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vps-webui.rule=Host(`${DASHBOARD_DOMAIN}`)"
      - "traefik.http.routers.vps-webui.entrypoints=websecure"
      - "traefik.http.routers.vps-webui.tls.certresolver=letsencrypt"
      - "traefik.http.routers.vps-webui.middlewares=${DASHBOARD_MIDDLEWARES:-}"
      - "traefik.http.services.vps-webui.loadbalancer.server.port=8080"
    depends_on:
      - backend
    restart: unless-stopped

networks:
  traefik:
    external: true
